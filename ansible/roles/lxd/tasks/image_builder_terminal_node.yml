---

# Author: Daniele Rondina, geaaru@gmail.com
# Description: Create Sabayon node with pam_radius module to test terminal
#              connection.

- name: "Prepare Terminal tester node with pam_radiusd"
  debug:
    msg: "Terminal test nodes: {{ pam_radiusd_nodes }} with profiles {{ freeradius_lxd_profiles }}"

# Create container
- name: Create a LXD Terminal test Container
  connection: "{{ lxd_target_server }}"
  lxd_container:
    name: "{{ item }}"
    state: started
    cert_file: "{{ lookup('env', 'HOME') }}/.config/lxc/client.crt"
    key_file: "{{ lookup('env', 'HOME') }}/.config/lxc/client.key"
    source:
      type: image
      mode: pull
      server: "{{ lxd_image_server }}"
      protocol: simplestreams # if you get a 404, try setting protocol: simplestreams
      alias: "{{ freeradius_lxd_image }}"
    ephemeral: True
    profiles: "{{ freeradius_lxd_profiles | list }}"
    wait_for_ipv4_addresses: true
    timeout: 600
  with_items:
    - "{{ pam_radiusd_nodes }}"
  tags:
    - create_terminal_container

# Configure pam authentication 
- name: Configure pam stuff
  include_role:
    name: freeradius
    tasks_from: configure-terminal-node
  loop_control:
    loop_var: container
  with_items:
    - "{{ pam_radiusd_nodes }}"
